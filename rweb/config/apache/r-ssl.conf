# Let Apache know we're behind a SSL reverse proxy
# SetEnvIf X-Forwarded-Proto https HTTPS=on

<IfModule !ssl_module>
  LoadModule ssl_module modules/mod_ssl.so
</IfModule>

Listen 443
SSLProtocol all -SSLv2 -SSLv3
SSLHonorCipherOrder on
SSLCipherSuite "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !EDH !RC4"
SSLPassPhraseDialog  builtin
SSLSessionCache "shmcb:/opt/bitnami/apache/logs/ssl_scache(512000)"
SSLSessionCacheTimeout  300

<VirtualHost _default_:80>

        RewriteEngine On
        RewriteCond %{HTTPS} !=on
        RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]

</VirtualHost>

<VirtualHost _default_:443>

  DocumentRoot "/opt/bitnami/apache/htdocs"

  <Directory "/opt/bitnami/apache/htdocs">
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
  </Directory>

  # Error Documents
  ErrorDocument 503 /503.html

  <Location /server-status>
    Require local
    SetHandler server-status
  </Location>
  
  SSLEngine on
  SSLCertificateFile /certs/server.crt
  SSLCertificateKeyFile /certs/server.key

  RewriteEngine on  

  
  # Shiny
  RedirectMatch permanent ^/shiny$ /
  RewriteCond %{HTTP:Upgrade} =websocket
  RewriteRule /shiny/(.*) ws://shiny:3838/$1 [P,L]
  RewriteCond %{HTTP:Upgrade} !=websocket
  RewriteRule /shiny/(.*) http://shiny:3838/$1 [P,L]
  ProxyPass / http://shiny:3838/
  ProxyPassReverse / http://shiny:3838/



  ProxyRequests Off

</VirtualHost>

